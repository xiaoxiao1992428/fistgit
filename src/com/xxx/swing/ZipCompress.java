package com.xxx.swing;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.OutputStream;
import java.util.List;
import java.util.zip.ZipEntry;
import java.util.zip.ZipOutputStream;

import javax.swing.JTextArea;

public class ZipCompress implements Runnable {

	
	  private String zipFileName;      // 目的地Zip文件
	    private String sourceFileName;   //源文件（带压缩的文件或文件夹）
	    private JTextArea jta ;
	    
	    public ZipCompress(String zipFileName,String sourceFileName,JTextArea jta)
	    {
	        this.zipFileName=zipFileName;
	        this.sourceFileName=sourceFileName;
	        this.jta=jta;
	    }
	    
//	    public void zip() throws Exception
//	    {
//	        File zipFile = new File("d:/u04/"+zipFileName);
//	        System.out.println("压缩中...");
//	        
//	        //创建zip输出流
//	        ZipOutputStream out = new ZipOutputStream( new FileOutputStream(zipFile));
//	        
//	        //创建缓冲输出流
//	        BufferedOutputStream bos = new BufferedOutputStream(out);
//	        
//	        File sourceFile = new File(sourceFileName);
//	        
//	        //调用函数
//	        compress(out,bos,sourceFile,sourceFile.getName());
//	        bos.flush();
//	        bos.close();
//	        out.close();
//	    }
	    
//	    public void compress(ZipOutputStream out,BufferedOutputStream bos,File sourceFile,String base) throws Exception
//	    {
//	        //如果路径为目录（文件夹）
//	        if(sourceFile.isDirectory())
//	        {
//	        
//	            //取出文件夹中的文件（或子文件夹）
//	            File[] flist = sourceFile.listFiles();
//	            
//	            if(flist.length==0)//如果文件夹为空，则只需在目的地zip文件中写入一个目录进入点
//	            {
//	                System.out.println(base+"/");
//	                out.putNextEntry(  new ZipEntry(base+"/") );
//	            }
//	            else//如果文件夹不为空，则递归调用compress，文件夹中的每一个文件（或文件夹）进行压缩
//	            {
//	                for(int i=0;i<flist.length;i++)
//	                {
//	                    compress(out,bos,flist[i],base+"/"+flist[i].getName());
//	                }
//	            }
//	        }
//	        else//如果不是目录（文件夹），即为文件，则先写入目录进入点，之后将文件写入zip文件中
//	        {
//	            out.putNextEntry( new ZipEntry(base) );
//	            FileInputStream fos = new FileInputStream(sourceFile);
//	            BufferedInputStream bis = new BufferedInputStream(fos);
//	            
//	            int tag;
//
//	            //将源文件写入到zip文件中
//	            while((tag=bis.read())!=-1)
//	            {
//	                out.write(tag);
//	            }
//	            bis.close();
//	            fos.close();
//		        jta.append(sourceFile.getName()+"压缩完成！");
//		        jta.paintImmediately(jta.getBounds()); 
//	            
//	        }
//	    }
	    
	    
	    /**

	     * 压缩成ZIP 方法2

	     * @param srcFiles 需要压缩的文件列表

	     * @param out           压缩文件输出流

	     * @throws RuntimeException 压缩失败会抛出运行时异常

	     */

	    public  void toZip(List<File> srcFiles , OutputStream out)throws RuntimeException {

	        long start = System.currentTimeMillis();

	        ZipOutputStream zos = null ;

	        try {

	            zos = new ZipOutputStream(out);

	            for (File srcFile : srcFiles) {

	                byte[] buf = new byte[2*1024];

	                zos.putNextEntry(new ZipEntry(srcFile.getName()));

	                int len;

	                FileInputStream in = new FileInputStream(srcFile);

	                while ((len = in.read(buf)) != -1){

	                    zos.write(buf, 0, len);

	                }

	                zos.closeEntry();

	                in.close();

	            }

	            long end = System.currentTimeMillis();

	            System.out.println("压缩完成，耗时：" + (end - start) +" ms");

	        } catch (Exception e) {

	            throw new RuntimeException("zip error from ZipUtils",e);

	        }finally{

	            if(zos != null){

	                try {

	                    zos.close();

	                } catch (IOException e) {

	                    e.printStackTrace();

	                }

	            }

	        }

	      }
	    
		  /**

	     * 压缩成ZIP 方法1

	     * @param srcDir 压缩文件夹路径 

	     * @param out    压缩文件输出流

	     * @param KeepDirStructure  是否保留原来的目录结构,true:保留目录结构; 

	     *                          false:所有文件跑到压缩包根目录下(注意：不保留目录结构可能会出现同名文件,会压缩失败)

	     * @throws RuntimeException 压缩失败会抛出运行时异常

	     */

	    public  void toZip(String srcDir, OutputStream out, boolean KeepDirStructure)

	            throws RuntimeException{

	        

	        long start = System.currentTimeMillis();

	        ZipOutputStream zos = null ;

	        try {

	            zos = new ZipOutputStream(out);

	            File sourceFile = new File(srcDir);

	            compress(sourceFile,zos,sourceFile.getName(),KeepDirStructure);

	            long end = System.currentTimeMillis();

	            System.out.println("压缩完成，耗时：" + (end - start) +" ms");

	        } catch (Exception e) {

	            throw new RuntimeException("zip error from ZipUtils",e);

	        }finally{

	            if(zos != null){

	                try {

	                    zos.close();

	                } catch (IOException e) {

	                    e.printStackTrace();

	                }

	            }

	        }

	        

	      }
	    
	    private  void compress(File sourceFile, ZipOutputStream zos, String name,
	    		
	    		            boolean KeepDirStructure) throws Exception{
	    		
	    		        byte[] buf = new byte[2*1024];
	    		
	    		        if(sourceFile.isFile()){
	    		
	    		            // 向zip输出流中添加一个zip实体，构造器中name为zip实体的文件的名字
	    		
	    		            zos.putNextEntry(new ZipEntry(name));
	    		
	    		            // copy文件到zip输出流中
	    		
	    		            int len;
	    		
	    		            FileInputStream in = new FileInputStream(sourceFile);
	    		
	    		            while ((len = in.read(buf)) != -1){
	    		
	    		                zos.write(buf, 0, len);
	    		
	    		            }
	    		
	    		            // Complete the entry
	    		            zos.flush();
	    		            zos.closeEntry();
	    		
	    		            in.close();
	    			        jta.append(sourceFile.getName()+"压缩完成！\r\n");
	    			        jta.paintImmediately(jta.getBounds());
	    		
	    		        } else {
	    		
	    		            File[] listFiles = sourceFile.listFiles();
	    		
	    		            if(listFiles == null || listFiles.length == 0){
	    		
	    		                // 需要保留原来的文件结构时,需要对空文件夹进行处理
	    		
	    		                if(KeepDirStructure){
	    		
	    		                    // 空文件夹的处理
	    		
	    		                    zos.putNextEntry(new ZipEntry(name + "/"));
	    		
	    		                    // 没有文件，不需要文件的copy
	    		                    zos.flush();
	    		                    zos.closeEntry();
	    		
	    		                }
	    		
	    		                
	    		
	    		            }else {
	    		
	    		                for (File file : listFiles) {
	    		
	    		                    // 判断是否需要保留原来的文件结构
	    		                	if(file.getName().lastIndexOf(".zip")>0){
	    		                		continue ;
	    		                	}else{
		    		                    if (KeepDirStructure) {
		    		        	    		
		    		                        // 注意：file.getName()前面需要带上父文件夹的名字加一斜杠,
		    		
		    		                        // 不然最后压缩包中就不能保留原来的文件结构,即：所有文件都跑到压缩包根目录下了
		    		
		    		                        compress(file, zos, name + "/" + file.getName(),KeepDirStructure);
		    		
		    		                    } else {
		    		
		    		                        compress(file, zos, file.getName(),KeepDirStructure);
		    		
		    		                    }
	    		                	}

	    		
	    		                    
	    		
	    		                }
	    		
	    		            }
	    		
	    		        }
	    		
	    		    }

		@Override
		public void run() {
			  try{
//				  File file = new File(sourceFileName);
			        System.out.println("压缩中...");
//			        File zipFile = new File("d:/u04/"+zipFileName);
//			        //创建zip输出流
//			        ZipOutputStream out = new ZipOutputStream( new FileOutputStream(zipFile));
//			        compress(file,out,zipFileName,false);
//			       
			        
			        FileOutputStream fos1 = new FileOutputStream(new File("d:/u04/"+zipFileName));
			        
			        toZip("D:/u04/", fos1,true);
			        jta.append("all files 压缩完成！\r\n");
			        jta.paintImmediately(jta.getBounds()); 
			        
			        
			        
			        
		        }catch(Exception e){
		            e.printStackTrace();
		        }
			
		}
}
